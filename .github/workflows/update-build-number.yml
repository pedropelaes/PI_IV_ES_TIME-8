name: Flutter Build

on:
  push:
    branches:
      - main
    paths:
      - "lib/**"
      - "assets/**"
      - "pubspec.yaml"
      - "pubspec.lock"
      - "android/**"
      - "ios/**"
      - "web/**"

jobs:
  build:
    if: github.actor != 'github-actions[bot]'

    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3

      - uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.13.0'

      - name: Install dependencies
        run: flutter pub get

      - name: Get current build number
        id: build_number
        run: |
          CURRENT=$(grep '^version:' pubspec.yaml | cut -d'+' -f2)
          if [ -z "$CURRENT" ]; then
            BUILD_NUMBER=1
          else
            BUILD_NUMBER=$((CURRENT + 1))
          fi
          echo "BUILD_NUMBER=$BUILD_NUMBER" >> $GITHUB_ENV
          echo "New build number: $BUILD_NUMBER"

      - name: Update pubspec.yaml
        run: |
          VERSION_BASE=$(grep '^version:' pubspec.yaml | cut -d'+' -f1)
          sed -i "s/^version:.*/${VERSION_BASE}+$BUILD_NUMBER/" pubspec.yaml
          echo "Updated version line:"
          grep '^version:' pubspec.yaml

      - name: Commit updated pubspec.yaml
        run: |
          git config --local user.email "actions@github.com"
          git config --local user.name "GitHub Actions"
          git add pubspec.yaml
          git commit -m "chore: update build number to $BUILD_NUMBER"
          git push origin main

      - name: Display build result
        run: echo "Build #$BUILD_NUMBER successfully registered and committed!"
